<%- include('../userLayout/header') %>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    .modal {
    display: none; 
    position: fixed; 
    z-index: 1; 
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%; 
    overflow: auto; 
    background-color: rgb(0,0,0); 
    background-color: rgba(0,0,0,0.9); 
    padding-top: 60px; 
}

.modal-content {
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px; 
}

.close {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    transition: 0.3s;
}

.close:hover,
.close:focus {
    color: #bbb;
    text-decoration: none;
    cursor: pointer;
}
.rating {
    display: inline-block;
    unicode-bidi: bidi-override;
    direction: rtl;
  }
  .rating input {
    display: none;
  }
  .rating label {
    font-size: 17px;
    color: #8b8b8b;
    display: inline-block;
    padding: 5px;
    cursor: pointer;
  }
  .rating label:hover,
  .rating label:hover ~ label,
  .rating input:checked ~ label {
    color: #f90;
  }
</style>
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/home" rel="nofollow" style="color: #000000;">Home</a>
                    <span></span>
                    <a href="/product-list" rel="nofollow" style="color: #000000;">Shop</a>
                    <span></span> View
                </div>
            </div>
        </div>
        <section class="mt-50 mb-50">
            <div class="container">
                <div class="row">
                    <div class="col-lg-9">
                        <div class="product-detail accordion-detail">
                            <div class="row mb-50">
                                <div class="col-md-4 col-sm-12 col-xs-12">
                                    <div id="imageModal" class="modal">
                                        <span class="close">&times;</span>
                                        <img class="modal-content" id="zoomedImage">
                                    </div>
                                    <div class="detail-gallery">
                                        <!-- MAIN SLIDES -->
                                        <div class="product-image-slider" >
                                            <% if (product.images && product.images.length > 0) { %>
                                                <% product.images.forEach((productImage) => { %>
                                                    <figure class="border-radius-10" >
                                                        <img src="/assets-admin/productImages/<%= productImage%>" alt="product image" style="max-height: 400px; width: 100%; height: 100%;" onclick="openModal('/assets-admin/productImages/<%= productImage%>')">
                                                    </figure>
                                                <% }) %>
                                            <% } %>
                                        </div>                                        
                                        <!-- THUMBNAILS -->
                                        <div class="slider-nav-thumbnails pl-15 pr-15">
                                            <% if (product.images && product.images.length > 0) { %>
                                                <% product.images.forEach((productImage, index) => { %>
                                                    <div>
                                                        <img class="thumbnail-image" src="/assets-admin/productImages/<%= productImage %>" alt="<%= product.title %>" data-index="<%= index %>">
                                                    </div>
                                                <% }) %>
                                            <% } %>
                                        </div>
                                    </div>
                                    <!-- End Gallery -->
                                    <div class="social-icons single-share">
                                        <ul class="text-grey-5 d-inline-block">
                                            <li><strong class="mr-10">Share this:</strong></li>
                                            <li class="social-facebook"><a href="#"><img src="/assets/imgs/theme/icons/icon-facebook.svg" alt=""></a></li>
                                            <li class="social-twitter"> <a href="#"><img src="/assets/imgs/theme/icons/icon-twitter.svg" alt=""></a></li>
                                            <li class="social-instagram"><a href="#"><img src="/assets/imgs/theme/icons/icon-instagram.svg" alt=""></a></li>
                                            <li class="social-linkedin"><a href="#"><img src="/assets/imgs/theme/icons/icon-pinterest.svg" alt=""></a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-6 col-sm-12 col-xs-12">
                                    <div class="detail-info">
                                        <h2 class="title-detail"><%= product.title  %></h2>
                                        <div class="product-detail-rating">
                                            <div class="pro-details-brand">
                                                <% if (product.status === 'out-of-stock') { %>
                                                    <span> Currently unavailable: <a href="#" class="text-danger"><%= product.status %></a></span>
                                                <% } %> <br>
                                                <span> Category: <a href="#"><%= product.category %></a></span>
                                            </div>
                                            <div class="product-rate-cover text-end">
                                                <div class="product-rate d-inline-block">
                                                    <div class="product-rating" style="width:90%">
                                                    </div>
                                                </div>
                                                <span class="font-small ml-5 text-muted"> (25 reviews)</span>
                                            </div>
                                        </div>
                                        <div class="clearfix product-price-cover">
                                            <div class="product-price primary-color float-left">
                                                <ins><span class="text-brand-dark">Rs.<%= product.afterDiscount%>/-</span></ins>
                                                <ins><span class="old-price font-md ml-15">Rs.<%= product.price%>/-</span></ins>
                                                <span class="save-price  font-md color3 ml-15"><%= product.discountPrice %>% off</span>
                                            </div>
                                        </div>
                                        <div class="bt-1 border-color-1 mt-15 mb-15"></div>
                                        <div class="short-desc mb-30">
                                            <span> Title: <a href="#"><%= product.title %></a></span><br>
                                            <span> Author: <a href="#"><%= product.author %></a></span><br>
                                            <span> ISBN: <a href="#"><%= product.ISBN %></a></span><br>
                                            <% if (product.countInStock <= 10 && product.countInStock >= 1 ) { %>
                                                <span class="text-danger"> Hurry up only <%= product.countInStock %> stocks left</span><br>
                                                <% } else  { %>
                                                 
                                            <% } %>
                                        </div>
                                        <div class="product_sort_info font-xs mb-30">
                                            <ul>
                                                <li class="mb-10 text-dark"><i class="fi-rs-refresh mr-5"></i> 30 Day Return Policy</li>
                                                <li><i class="fi-rs-credit-card mr-5"></i> Cash on Delivery available</li>
                                            </ul>
                                        </div>
                                        <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                                        <div class="detail-extralink">
                                            <div class="product-extra-link2">
                                                <button type="submit" class="button button-add-to-cart text-white" onclick="addToCart('<%= product._id %>', '<%= product.countInStock %>')">
                                                    ADD TO CART <i class=" fi-rs-shopping-bag-add"></i>
                                                </button>
                                                <button type="submit" class="button button-add-to-cart text-white" onclick="proceedCheckoutPage('<%= product._id %>', '<%= product.countInStock %>')">
                                                    BUY NOW
                                                </button>
                                                <a aria-label="Add To Wishlist" class="action-btn hover-up" href="shop-wishlist.html"><i class="fi-rs-heart"></i></a>
                                                <a aria-label="Compare" class="action-btn hover-up" href="shop-compare.html"><i class="fi-rs-shuffle"></i></a>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Detail Info -->
                                </div>
                            </div>
                            <!-- <div class="tab-pane fade show active" id="Description">
                                <div class="">
                                    <p></p>                       
                                </div>
                            </div> -->
                            <div class="tab-style3">
                                <ul class="nav nav-tabs text-uppercase">
                                    <li class="nav-item">
                                        <a class="nav-link active text-secondary" id="Description-tab" data-bs-toggle="tab" href="#Description">Description</a>
                                    </li>
                                    <li class="nav-item">
                                        <% if (review.length > 0) { %>
                                            <a class="nav-link text-secondary" id="Reviews-tab" data-bs-toggle="tab" href="#Reviews">Reviews (<%= review.length %>)</a>
                                            <% } else { %>
                                                <a class="nav-link text-secondary" id="Reviews-tab" data-bs-toggle="tab" href="#Reviews">Reviews (0)</a>
                                        <% } %>
                                        
                                    </li>
                                </ul>
                                <div class="tab-content shop_info_tab entry-main-content">
                                    <div class="tab-pane fade show active" id="Description">
                                       <div class="">
                                        <p>><%= product.description %></p>                       
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="Reviews">
                                        <div class="comments-area">
                                            <div class="row">
                                                <div class="col-lg-8">
                                                    <h4 class="mb-30">Reviews</h4>
                                                    <div class="comment-list">
                                                        <% if (review.length > 0) { %>
                                                            <% for (let i = 0; i < review.length; i++) { %>
                                                                <% const reviewItem = review[i]; %>
                                                                <div class="single-comment justify-content-between d-flex">  
                                                                    <div class="user justify-content-between d-flex">
                                                                        <div class="thumb text-center">
                                                                            <h6><a href="#"><%= reviewItem.userId.firstname %></a></h6>
                                                                            <% var reviewYear = reviewItem.createdAt.getFullYear(); %>
                                                                            <p><%= reviewYear %></p>
                                                                        </div>
                                                                        <div class="desc">Rating:
                                                                            <div class="d-inline-block">
                                                                                <div style="width: 100%;">
                                                                                    <% for (let j = 1; j <= 5; j++) { %>
                                                                                        <% if (j <= reviewItem.rating) { %>
                                                                                            <i class="fas fa-star" style="color: #f90;"></i>
                                                                                        <% } else { %>
                                                                                            <i class="far fa-star" style="color:#8b8b8b"></i>
                                                                                        <% } %>
                                                                                    <% } %><%= reviewItem.rating %>.0
                                                                                </div>
                                                                            </div>
                                                                            <p><%= reviewItem.reviewText  %></p>
                                                                            <div class="d-flex justify-content-between">
                                                                                <div class="d-flex align-items-center">
                                                                                    <p class="font-xs mr-30">submitted at: <%= reviewItem.createdAt.toLocaleDateString() %></p>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            <% } %>
                                                        <% } else { %>
                                                            <p>No Reviews</p>
                                                        <% } %>
                                                    </div>
                                                </div>                                                                                                
                                            </div>
                                        </div>                                        
                                        <form id="reviewForm">
                                            <div class="form-group">
                                              <label for="rating">ADD RATING</label>
                                              <div class="rating">
                                                <input type="radio" id="star5" name="rating" value="5"><label for="star5" title="5 stars"><i class="far fa-star"></i></label>
                                                <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 stars"><i class="far fa-star"></i></label>
                                                <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 stars"><i class="far fa-star"></i></label>
                                                <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 stars"><i class="far fa-star"></i></label>
                                                <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 star"><i class="far fa-star"></i></label>
                                              </div>
                                            </div>
                                            <input type="hidden" name="productId" value="<%= product._id %>">
                                            <div class="form-group">
                                              <label for="reviewText">Review:</label>
                                              <textarea id="reviewText" name="reviewText" required></textarea>
                                            </div>
                                            <button type="submit" onclick="sendReview()">Submit Review</button>
                                        </form>                                  
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-60">
                                <div class="col-12">
                                    <h3 class="section-title style-1 mb-30">Related products</h3>
                                </div>
                                <div class="col-12">
                                    <div class="row related-products">
                                        <% relatedCategory.forEach(product => { %>
                                        <div class="col-lg-3 col-md-4 col-12 col-sm-6">
                                            <div class="product-cart-wrap small hover-up">
                                                <div class="product-img-action-wrap">
                                                    <div class="product-img product-img-zoom">
                                                        <a href="/product-view?id=<%= product._id %>">
                                                            <img class="default-img" src="/assets-admin/productImages/<%= product.images[product.images.length - 1]%>"  alt="">
                                                            <img class="hover-img" src="<%= product.imageUrl %>" alt="">
                                                        </a>
                                                    </div>
                                                    <div class="product-badges product-badges-position product-badges-mrg">
                                                        <span class="hot">Hot</span>
                                                    </div>
                                                </div>
                                                <div class="product-content-wrap">
                                                    <h2><a href="#" tabindex="0"><%= product.title  %></a></h2>
                                                    <div class="rating-result" title="90%">
                                                        <span>
                                                        </span>
                                                    </div>
                                                    <div class="product-price">
                                                        <span>Rs.<%= product.afterDiscount  %>/-</span>
                                                        <span class="old-price">Rs.<%= product.price  %>/-</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>   
                                        <% }); %>       
                                    </div>
                                </div>
                            </div>
                            <div class="banner-img banner-big wow fadeIn f-none animated mt-50">
                                <img class="border-radius-10" src="" alt="">
                                <div class="banner-text">
                                    <h4 class="mb-15 mt-40"></h4>
                                    <h2 class="fw-600 mb-20"><br></h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 primary-sidebar sticky-sidebar">
                        <div class="widget-category mb-30">
                            <h5 class="section-title style-1 mb-30 wow fadeIn animated">Category</h5>
                            <% if (category) { %>
                                <% for (let i = 0; i < category.length; i++) { %>
                                    <li><a href="#"><%= category[i].name %></a></li>
                                <% } %>
                            <% } %>
                                                       
                        </div>
                        <!-- Fillter By Price -->
                        <!-- Product sidebar Widget -->
                        <div class="banner-img wow fadeIn mb-45 animated d-lg-block d-none">
                            <img src="" alt="">
                            <div class="banner-text">
                                <span></span>
                                <h4><br></h4>
                                <a href="#"><i class="fi-rs-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <!-- Preloader Start -->
    <div id="preloader-active">
        <div class="preloader d-flex align-items-center justify-content-center">
            <div class="preloader-inner position-relative">
                <div class="text-center">
                    <h5 class="mb-5">Now Loading</h5>
                    <div class="loader">
                        <div class="bar bar1"></div>
                        <div class="bar bar2"></div>
                        <div class="bar bar3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Vendor JS-->
    <script src="/assets/js/vendor/modernizr-3.6.0.min.js"></script>
    <script src="/assets/js/vendor/jquery-3.6.0.min.js"></script>
    <script src="/assets/js/vendor/jquery-migrate-3.3.0.min.js"></script>
    <script src="/assets/js/vendor/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/plugins/slick.js"></script>
    <script src="/assets/js/plugins/jquery.syotimer.min.js"></script>
    <script src="/assets/js/plugins/wow.js"></script>
    <script src="/assets/js/plugins/jquery-ui.js"></script>
    <script src="/assets/js/plugins/perfect-scrollbar.js"></script>
    <script src="/assets/js/plugins/magnific-popup.js"></script>
    <script src="/assets/js/plugins/select2.min.js"></script>
    <script src="/assets/js/plugins/waypoints.js"></script>
    <script src="/assets/js/plugins/counterup.js"></script>
    <script src="/assets/js/plugins/jquery.countdown.min.js"></script>
    <script src="/assets/js/plugins/images-loaded.js"></script>
    <script src="/assets/js/plugins/isotope.js"></script>
    <script src="/assets/js/plugins/scrollup.js"></script>
    <script src="/assets/js/plugins/jquery.vticker-min.js"></script>
    <script src="/assets/js/plugins/jquery.theia.sticky.js"></script>
    <script src="/assets/js/plugins/jquery.elevatezoom.js"></script>
    <!-- Template  JS -->
    <script src="/assets/js/main.js?v=3.4"></script>
    <script src="/assets/js/shop.js?v=3.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        async function addToCart(productId, countInStock) {
            try{
                let response = await fetch('/add/cart',{
                    method:'POST',
                    headers:{
                        'Content-Type':'application/json',
                    },
                    body: JSON.stringify({
                        productId,
                        countInStock                     
                    })
                });
                let title, text, iconClass;
                if (response.status === 200){
                    await Swal.fire({
                        title: 'Item added to cart!',
                        text: '',
                        icon: "success",
                        type: 'success',
                        timer: 1500,
                        timerProgressBar: true,
                    });
                    window.location.reload();
                } else if( response.status ===205){
                    await Swal.fire({
                        title:'Sorry! Out of Stock',
                        text:'Stock limit exceeded',
                        icon: 'Sorry',
                        timer: 1500
                    });
                }else {
                    title = 'Error';
                    text = 'Failed to add item to the cart.';
                    iconClass = 'error';
                }
            }catch(error){
                console.log(error.message);
                await Swal.fire({
                    title: 'Error',
                    text: 'An error occurred.',
                    icon: 'error',
                    position: 'center',
                    showConfirmButton: false,
                    timer: 2000,

                });
            }
        }

    async function proceedCheckoutPage(productId, countInStock) {
    try {
        let response = await fetch('/product/checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                productId,
            })
        });

        if (response.status === 200) {
            window.location.href = '/checkout';
        } else if (response.status === 205) {
            await Swal.fire({
                title: 'Sorry! Out of Stock',
                text: 'Stock limit exceeded',
                icon: 'Sorry',
                timer: 1500
            });
        } else if(response.status === 403){
            await Swal.fire({
            title: 'Warning',
            text: 'You have already stored maximum stock in the cart',
            icon: 'warning',
            timer: 3000
    });
        }
    } catch (error) {
        console.log(error.message);
        await Swal.fire({
            title: 'Error',
            text: 'An error occurred.',
            icon: 'error',
            timer: 2000,
        });
    }
}
        function openModal(imageUrl) {
        var modal = document.getElementById("imageModal");
        var modalImg = document.getElementById("zoomedImage");
        modal.style.display = "block";
        modalImg.src = imageUrl;
    }

    // Close the modal when the close button is clicked
    var span = document.getElementsByClassName("close")[0];
    span.onclick = function() {
        var modal = document.getElementById("imageModal");
        modal.style.display = "none";
    }

    
async function sendReview() {
    const rating = document.querySelector('input[name="rating"]:checked');
    const reviewText = document.querySelector('#reviewText').value;
    const productId = document.querySelector('input[name="productId"]').value;

    if (!rating || !reviewText || !productId) {
        await Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Please fill in all required fields!'
        });
        return;
    }
    const requestData = {
        productId: productId,
        rating: rating.value,
        reviewText: reviewText
    };
    try {
        const response = await fetch('/reviews', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });

        if (response.status === 200) {
            await Swal.fire({
                title: 'Review added successfully',
                text: '',
                icon: "success",
                type: 'success',
                timer: 1500,
                timerProgressBar: true,
            })
            window.location.reload();
        }else if(response.status === 405){
            await Swal.fire({
                title:'Sorry! Out of Stock',
                text:'You have already submitted a review for this product',
                icon: 'Sorry',
                timer: 1500
            }); 
        }else {
            title = 'Error';
            text = 'Failed to add item to the cart.';
            iconClass = 'error';
        }
    }catch(error){
        console.log(error.message);
        await Swal.fire({
            title: 'Error',
            text: 'An error occurred.',
            icon: 'error',
            position: 'center',
            showConfirmButton: false,
            timer: 2000,
        });
    }
}


 </script>
</body>
</html>