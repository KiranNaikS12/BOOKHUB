<%- include('../userLayout/header') %>
</style>
<body>
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Wishlist
                </div>
            </div>
        </div>
        <section class="mt-50 mb-50">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="table-responsive">
                            <table style="background-color: white;" class="table shopping-summery text-center">
                                <thead>
                                    <tr class="main-heading">
                                        <th scope="col" colspan="2">Product</th>
                                        <th scope="col">Price</th>
                                        <th scope="col">Stock Status</th>
                                        <th scope="col">Action</th>
                                        <th scope="col">Remove</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (wishlist && wishlist.items && wishlist.items.length > 0) { %>
                                        <% wishlist.items.forEach((item) => { %>
                                            <tr id="wishlistItem_<%= item.productId._id %>">
                                                <td class="image product-thumbnail"><img src="/assets-admin/productImages/<%= item.productId.images[item.productId.images.length -1] %>" alt="#"></td>
                                                <td class="product-des product-name">
                                                    <h5 class="product-name"><a href="#"><%= item.productId.title  %></a></h5>
                                                    <p class="font-xs"><%= item.productId.category  %><br></p>
                                                </td>
                                                <td class="price" data-title="Price"><span>Rs.<%= item.productId.afterDiscount  %>/-</span></td>
                                                <td class="text-center" data-title="Stock">
                                                    <% if (item.productId.status === 'out-of-stock') { %>
                                                        <span class="text-danger font-weight-bold"><%= item.productId.status  %></span>
                                                    <% } else { %>
                                                        <span class="color3 font-weight-bold"><%= item.productId.status  %></span>
                                                    <% } %>
                                                </td> 
                                                <td class="text-right" data-title="Cart">
                                                    <a aria-label="Add To Cart" class="action-btn hover-up"  onclick="addToCart('<%= item.productId._id %>')">
                                                        <i class="fi-rs-shopping-bag-add"></i>
                                                    </a>
                                                <td class="action" data-title="Remove"><a href="#" onclick="removeWishlist('<%= item.productId._id %>')"><i class="fi-rs-trash"></i></a></td>
                                            </tr>
                                        <% }); %>
                                    <% } else {%>
                                        <tr>
                                            <td colspan="6">Your wishlist is empty</td>
                                        </tr>
                                    <% } %>
                                </tbody>                                
                            </table>
                            <div class="d-flex justify-content-end"> 
                                <a href="/product-list"><button class="btn btn-sm"><i class="fi-rs-shopping-bag mr-5"></i>ADD MORE</button></a>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </section>
    </main>
    <!-- Preloader Start -->
    <div id="preloader-active">
        <div class="preloader d-flex align-items-center justify-content-center">
            <div class="preloader-inner position-relative">
                <div class="text-center">
                    <h5 class="mb-5">Now Loading</h5>
                    <div class="loader">
                        <div class="bar bar1"></div>
                        <div class="bar bar2"></div>
                        <div class="bar bar3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Vendor JS-->
    <script src="/assets/js/vendor/modernizr-3.6.0.min.js"></script>
    <script src="/assets/js/vendor/jquery-3.6.0.min.js"></script>
    <script src="/assets/js/vendor/jquery-migrate-3.3.0.min.js"></script>
    <script src="/assets/js/vendor/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/plugins/slick.js"></script>
    <script src="/assets/js/plugins/jquery.syotimer.min.js"></script>
    <script src="/assets/js/plugins/wow.js"></script>
    <script src="/assets/js/plugins/jquery-ui.js"></script>
    <script src="/assets/js/plugins/perfect-scrollbar.js"></script>
    <script src="/assets/js/plugins/magnific-popup.js"></script>
    <script src="/assets/js/plugins/select2.min.js"></script>
    <script src="/assets/js/plugins/waypoints.js"></script>
    <script src="/assets/js/plugins/counterup.js"></script>
    <script src="/assets/js/plugins/jquery.countdown.min.js"></script>
    <script src="/assets/js/plugins/images-loaded.js"></script>
    <script src="/assets/js/plugins/isotope.js"></script>
    <script src="/assets/js/plugins/scrollup.js"></script>
    <script src="/assets/js/plugins/jquery.vticker-min.js"></script>
    <!-- Template  JS -->
    <script src=".//assets/js/main.js?v=3.4"></script>
    <script src=".//assets/js/shop.js?v=3.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        async function addToCart(productId) {
            try{
                let response = await fetch('/add/cart',{
                    method:'POST',
                    headers:{
                        'Content-Type':'application/json',
                    },
                    body: JSON.stringify({
                        productId,
                                             
                    })
                });
                let title, text, iconClass;
                if (response.status === 200){
                    await Swal.fire({
                        title: 'Item added to cart!',
                        text: '',
                        icon: "success",
                        type: 'success',
                        timer: 1500,
                        timerProgressBar: true,
                    });
                    window.location.reload();
                    
                }else if( response.status ===205){
                    await Swal.fire({
                        title:'Sorry! Out of Stock',
                        text:'Stock limit exceeded',
                        icon: 'error',
                        
                    });
                    window.location.reload();
                }else if( response.status ===403){
                    await Swal.fire({
                    title: 'Limit Excceded',
                    text: 'You cannot add more than 5 items in a cart', 
                    icon: 'error',
                    showConfirmButton: true
                });  
                }else {
                    title = 'Error';
                    text = 'Failed to add item to the cart.';
                    iconClass = 'error';
                }
            }catch(error){
                console.log(error.message);
                await Swal.fire({
                    title: 'Error',
                    text: 'An error occurred.',
                    icon: 'error',
                    position: 'center',
                    showConfirmButton: false,
                    timer: 2000,

                });
            }
        }


        async function removeWishlist(productId){
            Swal.fire({
                title:'Are you sure?',
                text:"Do you want to remove from the wishlist",
                icon:"warning",
                showCancelButton:true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, remove it!'
            }).then((result) => {
                if(result.isConfirmed){
                    fetch('/remove/wishlist',{
                        method:'POST',
                        headers:{
                            'Content-Type':'application/json'
                        },
                        body: JSON.stringify({
                           productId
                        })
                    })
                    .then((response) => {
                        if(response.ok){
                            return response.json();
                        }else{
                            throw new Error('Network response was not ok');
                        }
                    })
                    .then((data) => {
                        if(data.success){
                             Swal.fire({
                                html: `
                            <img src="/assets/imgs/icons/Animation - 1709726532148.gif" alt="Wishlist Icon" style="width: 150px; height: 150px; display: block; margin: auto;">
                            <div>
                            <div >Item Removed from your wishlist</div>
                            </div>
                                `,
                             text: '',
                             type: 'success',
                           })
                        //update count dynamically
                        const wishlistCountElement = document.getElementById('wishlistCount');
                        if(wishlistCountElement){
                            wishlistCountElement.innerText = parseInt(wishlistCountElement.innerText) -1;
                        }
                        //removeRow:
                        const removedRow = document.getElementById(`wishlistItem_${productId}`);
                        if (removedRow) {
                            removedRow.remove();
                        }

                        //check if wishlist is empty:
                        const wishlistItem = document.querySelectorAll('.shopping-summery tbody tr');
                        if(wishlistItem.length === 0){
                            const wishlistTableBody = document.querySelector('.shopping-summery tbody');
                            if(wishlistTableBody){
                                wishlistTableBody.innerHTML = `
                                <tr>
                                <td colspan="6">Your wishlist is empty</td>
                                </tr>
                                `;
                            }
                        }

                        }else{
                            Swal.fire('Error Deleting product', data.message, 'error');
                        }
                    })
                    .catch((error) => {
                        swal.fire('Error', 'An error occurred while removing the product.', 'error');
                        console.error('Fetch Error:', error);
                    })
                }
            })
        }
    
</script>
</body>
</html>